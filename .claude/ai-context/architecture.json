{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "name": "MCH Architecture",
  "version": "2.0",
  "description": "Meeting Context Hub v2 architecture overview",

  "layers": [
    {
      "name": "TUI",
      "path": "src/tui/",
      "technology": "React + Ink",
      "responsibility": "User interface, input handling, display",
      "components": [
        "App.tsx - Root component, routing",
        "screens/ - Full screen components",
        "components/ - Reusable UI elements",
        "hooks/ - Custom React hooks"
      ]
    },
    {
      "name": "Use Cases",
      "path": "src/core/usecases/",
      "responsibility": "Application business logic orchestration",
      "components": [
        "add-context.usecase.ts",
        "search-context.usecase.ts",
        "list-contexts.usecase.ts",
        "manage-project.usecase.ts",
        "get-context.usecase.ts",
        "record-context.usecase.ts"
      ]
    },
    {
      "name": "Services",
      "path": "src/core/services/",
      "responsibility": "Domain logic implementation",
      "components": [
        "extract.service.ts - AI extraction with input validation",
        "embedding.service.ts - Text to vector with graceful degradation",
        "chain.service.ts - Similarity calculation with dimension validation",
        "config.service.ts - Configuration management",
        "retry.service.ts - Exponential backoff retry logic"
      ]
    },
    {
      "name": "Domain",
      "path": "src/core/domain/",
      "responsibility": "Domain entities and value objects",
      "components": [
        "context.ts - Context entity",
        "project.ts - Project entity"
      ]
    },
    {
      "name": "Adapters",
      "path": "src/adapters/",
      "responsibility": "External system integration",
      "components": [
        "ai/ - Claude and OpenAI adapters",
        "audio/ - Whisper and Sox recording adapters",
        "storage/ - SQLite adapter",
        "config/ - Environment and file-based config"
      ]
    },
    {
      "name": "i18n",
      "path": "src/i18n/",
      "responsibility": "Internationalization - bilingual UI strings (ko/en)",
      "components": [
        "index.ts - t() and ti() helper functions",
        "strings.ts - ~95 UI string catalog"
      ],
      "usage": {
        "t": "t(key, lang) - Simple translation",
        "ti": "ti(key, lang, params) - Translation with interpolation"
      }
    }
  ],

  "dependencies": {
    "runtime": {
      "@anthropic-ai/sdk": "Claude API client",
      "openai": "OpenAI API client (embedding, whisper)",
      "better-sqlite3": "SQLite database",
      "ink": "React for CLI",
      "react": "UI framework",
      "zod": "Schema validation",
      "dotenv": "Environment variables",
      "uuid": "ID generation"
    },
    "development": {
      "typescript": "Type system",
      "tsx": "TypeScript execution",
      "vitest": "Testing framework",
      "eslint": "Linting"
    }
  },

  "dataFlow": {
    "addContext": [
      "User input text",
      "TUI -> AddContextUseCase",
      "UseCase -> ExtractService (Claude)",
      "UseCase -> EmbeddingService (OpenAI)",
      "UseCase -> StorageAdapter (SQLite)",
      "UseCase -> ChainService (find related)",
      "Return result to TUI"
    ],
    "searchContext": [
      "User search query",
      "TUI -> SearchContextUseCase",
      "UseCase -> EmbeddingService (query embedding)",
      "UseCase -> StorageAdapter (all embeddings)",
      "UseCase -> ChainService (cosine similarity)",
      "Return ranked results to TUI"
    ],
    "recordContext": [
      "User starts recording (SPACE)",
      "RecordingAdapter captures audio",
      "User stops recording (SPACE)",
      "WhisperAdapter transcribes audio",
      "User reviews/edits transcription",
      "ExtractService extracts context",
      "EmbeddingService generates embedding",
      "StorageAdapter saves",
      "ChainService finds related",
      "Return result to TUI"
    ]
  },

  "patterns": {
    "architecture": "Clean Architecture",
    "di": "Constructor injection",
    "errorHandling": "Custom MCHError with error codes",
    "testing": "Unit tests for services, integration for adapters"
  },

  "errorHandling": {
    "baseClass": "MCHError extends Error",
    "properties": ["code: ErrorCode", "recoverable: boolean", "originalError?: Error"],
    "errorTypes": [
      "AIError - AI extraction failures",
      "EmbeddingError - Vector generation failures",
      "StorageError - Database operations",
      "TranscriptionError - Whisper API",
      "RecordingError - Sox recording",
      "ConfigError - Configuration issues",
      "InputError - Input validation"
    ],
    "errorCodes": {
      "config": ["MISSING_API_KEY", "INVALID_CONFIG"],
      "ai": ["AI_EXTRACTION_FAILED", "AI_RATE_LIMITED", "AI_NETWORK_ERROR"],
      "embedding": ["EMBEDDING_FAILED", "EMBEDDING_RATE_LIMITED"],
      "transcription": ["TRANSCRIPTION_FAILED", "TRANSCRIPTION_FILE_NOT_FOUND"],
      "recording": ["RECORDING_FAILED", "RECORDING_SOX_NOT_FOUND", "RECORDING_ALREADY_ACTIVE"],
      "storage": ["DB_CONNECTION_FAILED", "DB_QUERY_FAILED", "DB_NOT_INITIALIZED", "CONTEXT_NOT_FOUND", "PROJECT_NOT_FOUND", "PROJECT_NAME_DUPLICATE"],
      "input": ["INVALID_INPUT", "INPUT_TOO_SHORT"],
      "network": ["NETWORK_ERROR", "TIMEOUT_ERROR"]
    },
    "recovery": {
      "format": "{ ko: string; en: string }",
      "example": "ERROR_RECOVERY[ErrorCode.AI_RATE_LIMITED].ko"
    },
    "retry": {
      "service": "src/core/services/retry.service.ts",
      "defaultOptions": {
        "maxAttempts": 3,
        "baseDelayMs": 1000,
        "maxDelayMs": 10000,
        "backoffMultiplier": 2
      },
      "retryableErrors": ["AI_RATE_LIMITED", "AI_NETWORK_ERROR", "EMBEDDING_RATE_LIMITED", "NETWORK_ERROR", "TIMEOUT_ERROR"]
    },
    "tuiComponent": "ErrorDisplay.tsx - Shows error message, code, recovery guidance, retry option"
  }
}
